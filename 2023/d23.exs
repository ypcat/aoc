#!/usr/bin/env elixir

_ =
"""
--- Day 23: A Long Walk ---
The Elves resume water filtering operations! Clean water starts flowing over the edge of Island Island.

They offer to help you go over the edge of Island Island, too! Just hold on tight to one end of this impossibly long rope and they'll lower you down a safe distance from the massive waterfall you just created.

As you finally reach Snow Island, you see that the water isn't really reaching the ground: it's being absorbed by the air itself. It looks like you'll finally have a little downtime while the moisture builds up to snow-producing levels. Snow Island is pretty scenic, even without any snow; why not take a walk?

There's a map of nearby hiking trails (your puzzle input) that indicates paths (.), forest (#), and steep slopes (^, >, v, and <).

For example:

#.#####################
#.......#########...###
#######.#########.#.###
###.....#.>.>.###.#.###
###v#####.#v#.###.#.###
###.>...#.#.#.....#...#
###v###.#.#.#########.#
###...#.#.#.......#...#
#####.#.#.#######.#.###
#.....#.#.#.......#...#
#.#####.#.#.#########v#
#.#...#...#...###...>.#
#.#.#v#######v###.###v#
#...#.>.#...>.>.#.###.#
#####v#.#.###v#.#.###.#
#.....#...#...#.#.#...#
#.#########.###.#.#.###
#...###...#...#...#.###
###.###.#.###v#####v###
#...#...#.#.>.>.#.>.###
#.###.###.#.###.#.#v###
#.....###...###...#...#
#####################.#
You're currently on the single path tile in the top row; your goal is to reach the single path tile in the bottom row. Because of all the mist from the waterfall, the slopes are probably quite icy; if you step onto a slope tile, your next step must be downhill (in the direction the arrow is pointing). To make sure you have the most scenic hike possible, never step onto the same tile twice. What is the longest hike you can take?

In the example above, the longest hike you can take is marked with O, and your starting position is marked S:

#S#####################
#OOOOOOO#########...###
#######O#########.#.###
###OOOOO#OOO>.###.#.###
###O#####O#O#.###.#.###
###OOOOO#O#O#.....#...#
###v###O#O#O#########.#
###...#O#O#OOOOOOO#...#
#####.#O#O#######O#.###
#.....#O#O#OOOOOOO#...#
#.#####O#O#O#########v#
#.#...#OOO#OOO###OOOOO#
#.#.#v#######O###O###O#
#...#.>.#...>OOO#O###O#
#####v#.#.###v#O#O###O#
#.....#...#...#O#O#OOO#
#.#########.###O#O#O###
#...###...#...#OOO#O###
###.###.#.###v#####O###
#...#...#.#.>.>.#.>O###
#.###.###.#.###.#.#O###
#.....###...###...#OOO#
#####################O#
This hike contains 94 steps. (The other possible hikes you could have taken were 90, 86, 82, 82, and 74 steps long.)

Find the longest hike you can take through the hiking trails listed on your map. How many steps long is the longest hike?
"""

input = """
#.###########################################################################################################################################
#.......#.........#.....#...#...#.......#...###...#...#...#.......#####...#####.......#...#...#.....#.........#####.....#.......#...###...###
#######.#.#######.#.###.#.#.#.#.#.#####.#.#.###.#.#.#.#.#.#.#####.#####.#.#####.#####.#.#.#.#.#.###.#.#######.#####.###.#.#####.#.#.###.#.###
#.......#.......#.#.#...#.#.#.#.#...#...#.#...#.#.#.#.#.#.#.#...#...#...#...#...#...#.#.#.#.#.#...#.#.......#.....#.#...#.....#.#.#.....#...#
#.#############.#.#.#.###.#.#.#.###.#.###.###.#.#.#.#.#.#.#.#.#.###.#.#####.#.###.#.#.#.#.#.#.###.#.#######.#####.#.#.#######.#.#.#########.#
#.#.......#...#.#.#.#.###.#...#...#.#.#...#...#.#.#.#...#.#...#...#.#...#...#...#.#...#.#.#.#...#.#.#.>.>...#.....#.#.#...#...#.#.#.........#
#.#.#####.#.#.#.#.#.#.###.#######.#.#.#.###.###.#.#.#####.#######.#.###.#.#####.#.#####.#.#.###.#.#.#.#v#####.#####.#.#.#.#.###.#.#.#########
#.#.#.....#.#.#.#.#.#...#...#.....#.#...#...#...#.#.....#.#...###.#.#...#.#...#.#.#.>.>.#.#...#.#.#.#.#...###.#.....#.#.#.#...#.#.#.#.......#
#.#.#.#####.#.#.#.#.###.###.#.#####.#####.###.###.#####.#.#.#.###.#.#.###.#.#.#.#.#.#v###.###.#.#.#.#.###.###.#.#####.#.#.###.#.#.#.#.#####.#
#...#...###.#.#.#.#.#...###.#.#...#...#...###...#.#...#.#...#.#...#.#.###.#.#.#.#...#...#.#...#...#...#...#...#.....#.#.#.###.#.#.#.#.#.....#
#######.###.#.#.#.#.#.#####.#.#.#.###.#.#######.#.#.#.#.#####.#.###.#.###.#.#.#.#######.#.#.###########.###.#######.#.#.#.###.#.#.#.#.#.#####
#...#...#...#.#.#.#.#...#...#.#.#.#...#...>.>.#.#...#.#.....#.#...#.#...#.#.#.#.#.......#...#####...#...###...#...#.#.#.#.#...#...#...#.....#
#.#.#v###.###.#.#.#.###.#.###.#.#.#.#######v#.#.#####.#####.#.###.#.###.#.#.#.#.#.###############.#.#.#######.#.#.#.#.#.#.#.###############.#
#.#.#.>.#...#.#.#.#.#...#.#...#.#...###...#.#.#...#...#...#.#.....#.#...#.#.#...#.............#...#.#.......#.#.#.#.#.#.#.#...#.....#.......#
#.#.#v#.###.#.#.#.#.#.###.#.###.#######.#.#.#.###.#.###.#.#.#######.#.###.#.#################.#.###.#######.#.#.#.#.#.#.#.###.#.###.#.#######
#.#...#.....#.#.#...#...#.#.#...###...#.#...#...#.#.>.>.#.#.#...#...#...#...#...............#.#...#.###...#.#...#.#.#...#.....#...#.#.......#
#.###########.#.#######.#.#.#.#####.#.#.#######.#.###v###.#.#.#.#.#####.#####.#############.#.###.#.###.#.#.#####.#.#############.#.#######.#
#.#.........#.#.....#...#.#.#.#.....#.#.#...###.#...#...#...#.#.#.....#.....#.........#...#...#...#.....#...###...#.###...###...#.#.#.......#
#.#.#######.#.#####.#.###.#.#.#.#####.#.#.#.###.###.###.#####.#.#####.#####.#########.#.#.#####.###############.###.###.#.###.#.#.#.#.#######
#.#.#.......#.......#.....#...#.....#...#.#.....#...###.......#.....#.#.....#...#...#...#...#...#...#.........#...#.#...#.....#...#.#.....###
#.#.#.#############################.#####.#######.#################.#.#.#####.#.#.#.#######.#.###.#.#.#######.###.#.#.#############.#####.###
#.#.#...........#.................#...###...#...#...#...........#...#...#...#.#.#.#.#.......#.....#...#.......###...#.............#.#...#...#
#.#.###########.#.###############.###.#####.#.#.###.#.#########.#.#######.#.#.#.#.#.#.#################.#########################.#.#.#.###.#
#...#...#.......#.#...#.........#...#...#...#.#.#...#.....#...#...#...#...#...#...#...###...#...........#...#...#.....#...........#...#...#.#
#####.#.#.#######.#.#.#.#######.###.###.#.###.#.#.#######.#.#.#####.#.#.#################.#.#.###########.#.#.#.#.###.#.#################.#.#
#.....#.#.......#...#...#.......###.#...#.#...#...#######...#...###.#.#.................#.#.#.....#.......#.#.#.#.#...#...#.............#.#.#
#.#####.#######.#########.#########.#.###.#.###################.###.#.#################.#.#.#####.#.#######.#.#.#.#.#####.#.###########.#.#.#
#.....#.........###...###.........#.#...#...#.......#.........#.#...#.#...###...........#.#.....#...###.....#.#...#.....#.#.#.........#.#.#.#
#####.#############.#.###########.#.###.#####.#####.#.#######.#.#.###.#.#.###.###########.#####.#######.#####.#########.#.#.#.#######.#.#.#.#
#####.........###...#.#...........#...#.#...#.....#.#.......#...#.#...#.#...#.....#.....#.#.....###.....#...#.#.........#...#.......#...#...#
#############.###.###.#.#############.#.#.#.#####.#.#######.#####.#.###.###.#####.#.###.#.#.#######.#####.#.#.#.###################.#########
#.............#...#...#.........#...#...#.#.#...#.#.###...#.....#.#...#.#...#...#...#...#.#...#...#.....#.#.#.#.#...#####...###...#.........#
#.#############.###.###########.#.#.#####.#.#.#.#.#.###.#.#####.#.###.#.#.###.#.#####v###.###.#.#.#####.#.#.#.#.#.#.#####.#.###v#.#########.#
#.#...###...###.#...###...###...#.#.#...#.#.#.#.#.#.#...#.......#...#...#.#...#.#...>.>...#...#.#.#...#.#.#.#.#.#.#...#...#...>.#...........#
#.#.#.###.#.###.#.#####.#.###.###.#.#.#.#.#.#.#.#.#.#.#############.#####.#.###.#.###v#####.###.#.#.#.#v#.#.#.#.#.###.#.#######v#############
#...#.....#...#.#...#...#...#...#.#.#.#.#.#.#.#.#.#.#.......#.....#...#...#.###...###.###...#...#.#.#.>.>.#.#.#.#.###.#.....#...###...#...###
#############.#.###.#.#####.###.#.#.#.#.#.#.#.#.#.#.#######v#.###.###.#.###.#########.###.###.###.#.###v###.#.#.#.###.#####.#.#####.#.#.#.###
#...#.........#...#.#...#...###.#.#.#.#.#.#...#.#.#.......>.>.###.#...#.#...#.......#...#...#.###.#.###...#.#.#.#.###.#.....#.......#...#...#
#.#.#.###########.#.###.#.#####v#.#.#.#.#.#####.#.#########v#####.#.###.#.###.#####.###.###.#.###.#.#####.#.#.#.#.###.#.###################.#
#.#...#...#...#...#...#.#...#.>.>.#.#.#.#.#.....#...#.....#.#...#...###...###.....#...#...#...#...#...#...#...#...###.#.#...................#
#.#####.#.#.#.#.#####.#.###.#.#v###.#.#.#.#.#######.#.###.#.#.#.#################.###.###.#####.#####.#.#############.#.#.###################
#.#...#.#.#.#.#.....#.#...#...#...#.#.#.#.#.#...#...#...#.#...#.........#...#...#...#...#...#...#.....#...#...#.....#...#...................#
#.#.#v#.#.#.#.#####.#.###.#######.#.#.#.#.#.#.#.#.#####.#.#############.#.#.#.#.###.###.###.#.###.#######.#.#.#.###.#######################.#
#...#.>.#...#...#...#.#...#.......#...#...#.#.#.#.#.....#.......#.......#.#.#.#.#...###.#...#...#.#.....#.#.#...#...###...#...........#...#.#
#####v#########.#.###.#.###.###############.#.#.#.#.###########.#.#######.#.#.#.#.#####.#.#####.#.#.###.#.#.#####.#####.#.#.#########.#.#.#.#
#.....#####...#.#.###.#.###...#.........###...#...#...........#...#...#...#...#...#...#.#.#...#...#...#...#.#.....#.....#.#.#.......#.#.#.#.#
#.#########.#.#.#.###.#.#####.#.#######.#####################.#####.#.#.###########.#.#.#.#.#.#######.#####.#.#####.#####.#.#.#####.#.#.#.#.#
#.#.......#.#.#.#...#...#...#...#.......#...#.................#.....#.#.............#.#...#.#.#...###...#...#.....#.....#.#...#.....#...#...#
#.#.#####.#.#.#.###.#####.#.#####.#######.#.#.#################.#####.###############.#####.#.#.#.#####.#.#######.#####.#.#####.#############
#.#.#.....#.#.#...#.#.....#.#...#.....#...#.#.....#...#...#...#.....#.#...#...#.......#.....#.#.#.#.....#.###.....#...#.#.#...#.............#
#.#.#.#####.#.###.#.#.#####.#.#.#####.#.###.#####.#.#.#.#.#.#.#####.#.#.#.#.#.#.#######.#####.#.#.#.#####.###.#####.#.#.#.#.#.#############.#
#...#...#...#...#...#.#...#...#.......#...#.....#...#.#.#...#.#.....#.#.#.#.#.#.###...#.#.....#.#.#.....#.#...#.....#.#.#...#...............#
#######.#.#####.#####.#.#.###############.#####.#####.#.#####.#.#####.#.#.#.#.#v###.#.#.#.#####.#.#####.#.#.###.#####.#.#####################
#.......#.#.....#...#...#...............#.....#.....#...#.....#.....#.#.#...#.>.>.#.#.#.#...#...#...###...#...#.....#.#.....................#
#.#######.#.#####.#.###################.#####.#####.#####.#########.#.#.#######v#.#.#.#.###.#.#####.#########.#####.#.#####################.#
#.#.....#.#.###...#.#...#...............#...#...#...#.....#...#...#.#.#.#.......#.#.#.#.#...#.....#.###...###.#...#.#.....#...............#.#
#.#.###.#.#.###.###.#.#.#.###############.#.###.#.###.#####.#.#.#.#.#.#.#.#######.#.#.#.#.#######.#.###.#.###v#.#.#.#####.#.#############.#.#
#.#...#...#...#...#...#.#.........#...#...#.....#...#.###...#.#.#...#.#.#.......#...#.#.#...#...#.#.#...#.#.>.>.#...#.....#.............#...#
#.###.#######v###.#####.#########.#.#.#.###########.#.###.###.#.#####.#.#######.#####.#.###.#.#.#.#.#.###.#.#v#######.#################.#####
#...#.#.....#.>.#.#.....#...#.....#.#.#.........#...#...#...#.#.#...#.#.###...#.....#.#.#...#.#.#.#.#.#...#.#.#.......#...#...........#.....#
###.#.#.###.#v#.#.#.#####.#.#.#####.#.#########.#.#####.###.#.#.#.#.#.#.###.#.#####.#.#.#.###.#.#.#.#.#.###.#.#.#######.#.#.#########.#####.#
###.#.#...#.#.#.#.#.#...#.#.#.#...#.#.###...###.#.###...###.#...#.#.#.#.#...#.......#...#...#.#...#.#.#...#.#.#.....###.#.#.....#...#...#...#
###.#.###.#.#.#.#.#.#.#.#.#.#v#.#.#.#.###.#.###.#.###v#####.#####.#.#.#.#.#################.#.#####.#.###.#.#.#####.###.#.#####.#.#.###.#.###
###.#.#...#...#.#.#.#.#.#.#.>.>.#...#.#...#.#...#.#.>.>...#.....#.#.#...#.............#.....#.#...#...#...#.#.###...#...#.#...#...#...#...###
###.#.#.#######.#.#.#.#.#.###v#######.#.###.#.###.#.#v###.#####.#.#.#################.#.#####.#.#.#####.###.#.###.###.###.#.#.#######.#######
#...#.#...#...#...#...#.#.#...#...###...#...#...#.#.#...#.#.....#.#.#...#...#...#.....#.....#...#...#...#...#...#...#.#...#.#.#.......###...#
#.###.###.#.#.#########.#.#.###.#.#######.#####.#.#.###.#.#.#####.#.#.#.#.#.#.#.#.#########.#######.#.###.#####.###.#.#.###.#.#v#########.#.#
#...#.###...#.....#.....#.#.#...#.....#...#...#.#...###.#.#.....#.#...#...#...#.#.....#...#.........#.....#...#.###...#...#.#.>.#.........#.#
###.#.###########.#.#####.#.#.#######.#.###.#.#.#######.#.#####.#.#############.#####.#.#.#################.#.#.#########.#.###v#.#########.#
###...#...#.......#.......#.#.#.......#.#...#...#.......#.......#.............#.#.....#.#.#.........###.....#...#...#####...###...#.......#.#
#######.#.#.###############.#.#.#######.#.#######.###########################.#.#.#####.#.#.#######.###.#########.#.###############.#####.#.#
#.......#.#...#...#####.....#.#...#...#...#.....#.........#.........#.........#.#.....#.#.#.......#...#.......#...#...###...#.......#...#...#
#.#######.###.#.#.#####.#####.###.#.#.#####.###.#########.#.#######.#.#########.#####.#.#.#######.###.#######.#.#####.###.#.#.#######.#.#####
#...#...#.....#.#.....#.....#.#...#.#...###.#...#.....###...#.......#.........#.......#.#.#.....#...#.#.......#...#...#...#...#...###.#.....#
###.#.#.#######.#####.#####.#.#.###.###.###.#.###.###.#######v###############.#########.#.#.###.###.#.#.#########.#.###.#######.#.###.#####.#
###...#.........#.....#...#.#.#...#.#...#...#.#...#...#...#.>.>...###...#.....#.....#...#.#.#...#...#.#.....#...#.#...#.........#.....#.....#
#################.#####.#.#.#.###.#.#.###.###.#.###.###.#.#.#v###.###.#.#.#####.###.#.###.#.#.###.###.#####.#.#.#.###.#################.#####
#...#.............#...#.#.#...#...#.#...#.#...#...#...#.#...#...#...#.#.#.....#.#...#...#.#.#.###...#.#...#.#.#.#...#.#.................#...#
#.#.#.#############.#.#.#.#####.###.###.#.#.#####.###.#.#######.###.#.#.#####.#.#.#####.#.#.#.#####.#.#.#.#v#.#.###.#.#.#################.#.#
#.#.#...............#.#.#.....#.....###.#.#.#...#...#.#.#.......#...#.#.###...#.#.#...#.#.#.#.......#...#.>.>.#...#.#.#.................#.#.#
#.#.#################.#.#####.#########.#.#.#.#.###.#.#.#.#######.###.#.###v###.#.#.#.#.#.#.###############v#####.#.#.#################.#.#.#
#.#.......###.......#.#.#.....#...#.....#.#.#.#.....#.#.#.......#...#.#.#.>.>.#.#.#.#.#.#.#.#.........#...#.#.....#.#...#...#.......#...#.#.#
#.#######.###.#####.#.#.#.#####.#.#.#####.#.#.#######.#.#######.###.#.#.#.#v#.#.#.#.#.#.#.#.#.#######.#.#.#.#.#####.###.#.#.#v#####.#.###.#.#
#...#...#.....#...#...#.#...#...#.#.....#.#.#.......#...#...###...#...#.#.#.#...#.#.#.#.#.#.#.......#...#...#.#...#.###.#.#.>.#...#...###.#.#
###.#.#.#######.#.#####.###.#.###.#####.#.#.#######.#####.#.#####.#####.#.#.#####.#.#.#.#.#.#######.#########.#.#.#.###.#.###v#.#.#######.#.#
###...#...#...#.#.#...#.#...#...#.#...#.#.#.#.......#.....#.......#...#...#.....#...#.#.#...###...#.........#...#.#.###.#...#.#.#.#.....#.#.#
#########.#.#.#.#.#.#.#.#.#####.#.#.#.#v#.#.#.#######.#############.#.#########.#####.#.#######.#.#########.#####.#.###.###.#.#.#.#.###.#.#.#
#.........#.#.#.#.#.#.#.#...#...#...#.>.>.#...#...###.....#.........#...#.......#.....#.#.......#.........#.#.....#.#...#...#.#.#.#.#...#.#.#
#.#########.#v#.#.#.#.#.###.#.#########v#######.#.#######.#.###########.#.#######.#####.#.###############.#.#.#####.#.###.###.#.#.#.#.###.#.#
#.#...#.....#.>.#.#.#...###.#...###...#.........#...#.....#.#...........#.......#.......#...............#.#.#.......#.#...###...#...#.....#.#
#.#.#.#.#####v###.#.#######.###.###.#.#############.#.#####.#.#################.#######################.#.#.#########.#.###################.#
#...#...###...###...###.....#...#...#.............#.#.#.....#.#...#.....#.......#.....#.......#.........#...#...#...#...#.................#.#
###########.###########.#####.###.###############.#.#.#.#####.#.#.#.###.#.#######.###.#.#####.#.#############.#.#.#.#####.###############.#.#
#.....#...#.....#.....#...#...###...#.....#...###...#.#.#...#...#...#...#.........#...#.....#.#...........#...#...#.....#...............#.#.#
#.###.#.#.#####.#.###.###.#.#######.#.###.#.#.#######.#.#.#.#########.#############.#######.#.###########.#.###########.###############.#.#.#
#...#.#.#.#...#...#...###.#.#.......#.#...#.#.......#...#.#.#...#...#...#...........###.....#.....#.......#...#.........#...#####...#...#.#.#
###.#.#.#.#.#.#####.#####.#.#.#######.#.###.#######.#####.#.#.#.#.#.###.#.#############.#########.#.#########.#.#########.#.#####.#.#.###.#.#
#...#...#...#.....#.#.....#.#.........#.....#.....#.#.....#...#...#.....#.........#...#...#.....#.#.....#...#.#...#...#...#.#.....#...###.#.#
#.###############.#.#.#####.#################.###.#.#.###########################.#.#.###.#.###.#.#####.#.#.#.###.#.#.#.###.#.###########.#.#
#.....#.....#...#...#.......#...#.............###.#.#...#.............#...........#.#.#...#.###.#.......#.#.#.#...#.#.#...#.#.......#...#...#
#####.#.###.#.#.#############.#.#.###############.#.###.#.###########.#.###########.#.#.###.###.#########.#.#.#.###.#.###.#.#######.#.#.#####
#.....#.###...#...#.....#...#.#.#...#.......#...#...###...###...#.....#.............#.#.#...#...#...#...#.#.#.#.###.#.###.#.#...#...#.#.#...#
#.#####.#########.#.###.#.#.#.#.###v#.#####.#.#.#############.#.#.###################.#.#.###.###.#.#.#.#.#.#.#.###.#.###.#.#.#.#v###.#.#.#.#
#.#...#.#.....#...#...#.#.#.#.#.#.>.>.#.....#.#...###...#.....#...###...###...........#...#...#...#.#.#...#.#.#.#...#...#.#...#.>.###.#.#.#.#
#.#.#.#.#.###.#v#####.#.#.#.#.#.#.#v###.#####.###.###.#.#.###########.#.###v###############.###.###.#.#####.#.#.#.#####.#.#######v###.#.#.#.#
#...#...#...#.#.>...#.#.#.#.#.#...#.###...#...#...#...#.#.....#.......#.#.>.>...#...#...###...#.#...#.....#.#.#.#.#.....#...#####...#.#...#.#
###########.#.#v###.#.#.#.#.#.#####.#####.#.###.###.###.#####.#.#######.#.#v###.#.#.#.#.#####.#.#.#######.#.#.#.#.#.#######.#######.#.#####.#
###...#...#.#...###...#.#.#...#.....#...#...###...#...#...###...#.......#.#...#.#.#.#.#.#...#...#...#.....#...#.#.#.#...#...#.......#...#...#
###.#.#.#.#.###########.#.#####.#####.#.#########.###.###.#######.#######.###.#.#.#.#.#.#.#.#######.#.#########.#.#.#.#.#.###.#########.#.###
#...#.#.#...#...#...###...#...#.......#.....#...#...#.#...#...###.#...###...#.#.#.#.#.#.#.#.#.....#.#.......#...#.#...#.#.#...#...#.....#...#
#.###.#.#####.#.#.#.#######.#.#############.#.#.###.#.#.###.#.###v#.#.#####.#.#.#.#.#.#.#.#.#.###.#.#######.#.###.#####.#.#.###.#.#.#######.#
#...#.#.......#...#.....#...#.....#...#...#...#.#...#.#.....#...>.>.#...#...#.#.#.#.#.#.#.#.#...#.#.#...#...#...#.###...#.#.....#.#.#.......#
###.#.#################.#.#######.#.#.#.#.#####.#.###.###########v#####.#.###.#.#.#.#.#.#.#.###.#.#v#.#.#.#####.#.###.###.#######.#.#.#######
#...#...#...#.....#...#.#.#.....#...#...#.....#.#...#.#...........###...#.#...#...#.#.#...#...#.#.>.>.#...#...#...#...#...###.....#.#.......#
#.#####.#.#.#.###.#.#.#.#.#.###.#############.#.###.#.#.#############.###.#.#######.#.#######.#.###v#######.#.#####.###.#####.#####.#######.#
#.....#...#.#...#...#...#...###...#...#.....#.#...#.#.#.#...........#.....#.......#.#...#.....#.#...#.......#.....#.....###...#...#.#.......#
#####.#####.###.#################.#.#.#.###.#.###.#.#.#.#.#########.#############.#.###.#.#####.#.###.###########.#########.###.#.#.#.#######
#.....#...#.....#...###...#...###...#.#.#...#...#.#...#...#.........#...#...###...#.....#.......#...#.#...........###.....#.#...#.#.#.#...###
#.#####.#.#######.#.###.#.#.#.#######.#.#.#####.#.#########.#########.#.#.#.###.###################.#.#.#############.###.#.#.###.#.#.#.#.###
#.#...#.#...#.....#...#.#.#.#.#.......#.#.#####...###...###.........#.#.#.#...#...#.....#.......###...#.....#...#...#.#...#...###...#...#...#
#.#.#.#.###.#.#######.#.#.#.#.#.#######.#.###########.#.###########.#.#.#.###.###.#.###.#.#####.###########.#.#.#.#.#.#.###################.#
#.#.#.#...#.#.....#...#.#.#.#.#...#...#.#.........#...#.#...........#.#.#.#...#...#...#.#.....#.#...###.....#.#.#.#.#.#.#...#...#...........#
#.#.#.###.#.#####.#.###.#.#.#.###v#.#.#.#########.#.###.#.###########.#.#.#.###v#####.#.#####.#.#.#.###.#####.#.#.#.#.#.#.#.#.#.#.###########
#...#...#.#...#...#.#...#.#.#.#.>.>.#.#.#.........#...#.#.....#...#...#...#...>.>...#.#.....#.#.#.#.#...#.....#.#.#...#.#.#.#.#.#...........#
#######.#.###.#.###.#.###.#.#.#.#####.#.#.###########.#.#####.#.#.#.###############.#.#####.#.#.#.#.#.###.#####.#.#####.#.#.#.#.###########.#
#.......#...#.#...#...#...#.#.#.....#.#.#...###.....#.#.......#.#.#.........#.......#.#.....#.#.#.#.#...#...#...#.#.....#.#.#.#...#.....#...#
#.#########.#.###.#####.###.#.#####.#.#.###.###.###.#.#########.#.#########.#.#######.#.#####.#.#.#.###v###.#.###.#.#####.#.#.###.#.###.#.###
#...#...#...#.....#.....#...#.#...#.#.#.###...#...#.#.........#.#.......#...#.#.....#.#...#...#.#.#.#.>.>.#.#...#.#.#.....#.#...#.#.#...#...#
###.#.#.#.#########.#####.###.#.#.#.#.#.#####.###.#.#########.#.#######.#.###.#.###.#.###.#.###.#.#.#.###.#.###.#.#.#.#####.###.#.#.#.#####.#
###.#.#.#.........#...#...###.#.#.#.#...#...#...#.#.......#...#.......#...###...#...#.#...#.###...#.#.#...#.#...#.#.#.....#.###.#.#.#.###...#
###.#.#.#########.###.#.#####.#.#.#.#####.#.###.#.#######.#.#########.###########.###.#.###.#######.#.#.###.#.###.#.#####.#.###.#.#.#.###v###
###...#...#...#...#...#.#####.#.#.#.#.....#.....#.....#...#...#.....#.......###...#...#...#.....#...#.#...#.#.#...#.#.....#.#...#.#.#.#.>.###
#########.#.#.#.###.###.#####.#.#.#.#.###############.#.#####v#.###.#######.###.###.#####.#####.#.###.###.#.#.#.###.#.#####.#.###.#.#.#.#v###
#.........#.#.#...#...#...#...#.#.#.#.......#...#...#.#...#.>.>.#...#...#...#...#...#...#...#...#...#.###.#.#.#.###.#.#.....#...#.#.#...#...#
#.#########.#.###.###.###.#.###.#.#.#######.#.#.#.#.#.###.#.#####.###.#.#.###.###.###.#.###.#.#####.#.###.#.#.#.###.#.#.#######.#.#.#######.#
#.#.......#.#.....###.#...#.#...#.#.#.......#.#...#.#.###.#...#...#...#.#...#...#.#...#.....#.....#...#...#.#.#.###...#.....#...#.#.#.......#
#.#.#####.#.#########.#.###.#.###.#.#.#######.#####.#.###.###.#.###.###.###.###.#.#.#############.#####.###.#.#.###########.#.###.#.#.#######
#.#.#.....#.........#.#...#.#.#...#.#...#...#.#.....#...#.#...#...#...#...#...#.#.#.#...#...#...#.....#.#...#.#.......#.....#...#.#.#.#.....#
#.#.#.#############.#.###.#.#.#.###.###.#.#.#.#.#######.#.#.#####.###.###.###.#.#.#.#.#.#.#.#.#.#####.#.#.###.#######.#.#######.#.#.#.#.###.#
#...#...............#.....#...#.....###...#...#.........#...#####.....###.....#...#...#...#...#.......#...###.........#.........#...#...###.#
###########################################################################################################################################.#
"""

defmodule D23 do
  def parse(input) do
    for {r, i} <- input |> String.split("\n", trim: true) |> Enum.with_index(),
        {c, j} <- r |> to_charlist() |> Enum.with_index(),
        into: %{}, do: {{i, j}, c}
  end
  def part1(m) do
    g = :digraph.new()
    {start, goal} = for {p, ?.} <- m do
      :digraph.add_vertex(g, p)
    end
    |> Enum.min_max()
    for p = {i, j} <- :digraph.vertices(g),
        q <- [{i + 1, j}, {i, j + 1}, {i - 1, j}, {i, j - 1}] do
      case m[q] do
        ?. -> :digraph.add_edge(g, p, q, 1)
        ?^ when q == {i - 1, j + 0} -> :digraph.add_edge(g, p, {i - 2, j + 0}, 2)
        ?> when q == {i + 0, j + 1} -> :digraph.add_edge(g, p, {i + 0, j + 2}, 2)
        ?v when q == {i + 1, j + 0} -> :digraph.add_edge(g, p, {i + 2, j + 0}, 2)
        ?< when q == {i + 0, j - 1} -> :digraph.add_edge(g, p, {i + 0, j - 2}, 2)
        _ -> nil
      end
    end
    dfs(g, start, goal, 0, start)
  end
  def dfs(_g, goal, goal, step, _last), do: step
  def dfs(g, curr, goal, step, last) do
    for edge <- :digraph.out_edges(g, curr),
        {_, _, next, len} = :digraph.edge(g, edge),
        next != last do
      dfs(g, next, goal, step + len, curr)
    end
    |> Enum.max()
  end

  def add_edge(g, p, q, w) do
    g
    |> Map.update(p, [{q, w}], & &1 ++ [{q, w}])
    |> Map.update(q, [{p, w}], & &1 ++ [{p, w}])
  end
  def build_graph2(input) do
    for {{i, j}=p, c} <- input, c != ?#,
        q <- [{i - 1, j}, {i, j - 1}], input[q] && input[q] != ?#,
        reduce: %{} do
      g -> add_edge(g, p, q, 1)
    end
  end
  def del_vert(g, p) do
    Enum.reduce(g[p], Map.delete(g, p), fn {q, _}, g -> update_in(g[q], &List.keydelete(&1, p, 0)) end)
  end
  def dfs2(_, goal, goal), do: 0
  def dfs2(g, curr, goal) do
    Enum.reduce(g[curr], nil, fn {next, w}, acc ->
      case {acc, dfs2(del_vert(g, curr), next, goal)} do
        {nil, nil} -> nil
        {nil, n} -> n + w
        {_, nil} -> acc
        {_, n} -> max(acc, n + w)
      end
    end)
  end
  def compress(g, p, visited) do
    case p in visited do
      true -> g
      false ->
        visited = MapSet.put(visited, p)
        case g[p] do
          nil -> g
          edges ->
            g = case edges do
              [{q1, w1}, {q2, w2}] -> g
                |> del_vert(p)
                |> update_in([q1], &[{q2, w1 + w2} | &1])
                |> update_in([q2], &[{q1, w1 + w2} | &1])
              _ -> g
            end
            Enum.reduce(edges, g, fn {q, _}, g -> compress(g, q, visited) end)
        end
    end
  end
  def part2(input) do
    g = build_graph2(input)
    {start, goal} = Map.keys(g) |> Enum.min_max()
    g = compress(g, start, MapSet.new())
    dfs2(g, start, goal)
  end
end

_ = """
#.#####################
#.......#########...###
#######.#########.#.###
###.....#.>.>.###.#.###
###v#####.#v#.###.#.###
###.>...#.#.#.....#...#
###v###.#.#.#########.#
###...#.#.#.......#...#
#####.#.#.#######.#.###
#.....#.#.#.......#...#
#.#####.#.#.#########v#
#.#...#...#...###...>.#
#.#.#v#######v###.###v#
#...#.>.#...>.>.#.###.#
#####v#.#.###v#.#.###.#
#.....#...#...#.#.#...#
#.#########.###.#.#.###
#...###...#...#...#.###
###.###.#.###v#####v###
#...#...#.#.>.>.#.>.###
#.###.###.#.###.#.#v###
#.....###...###...#...#
#####################.#
"""

input
|> D23.parse()
|> D23.part1()
|> IO.inspect(label: :part1, charlists: :as_lists)

_ = """
#.#####################
#.......#########...###
#######.#########.#.###
###.....#.>.>.###.#.###
###v#####.#v#.###.#.###
###.>...#.#.#.....#...#
###v###.#.#.#########.#
###...#.#.#.......#...#
#####.#.#.#######.#.###
#.....#.#.#.......#...#
#.#####.#.#.#########v#
#.#...#...#...###...>.#
#.#.#v#######v###.###v#
#...#.>.#...>.>.#.###.#
#####v#.#.###v#.#.###.#
#.....#...#...#.#.#...#
#.#########.###.#.#.###
#...###...#...#...#.###
###.###.#.###v#####v###
#...#...#.#.>.>.#.>.###
#.###.###.#.###.#.#v###
#.....###...###...#...#
#####################.#
"""

input
|> D23.parse()
|> D23.part2()
|> IO.inspect(label: :part2, charlists: :as_lists)

