#!/usr/bin/env elixir

defmodule D21 do
  def parse(input) do
    for {r, i} <- input |> String.split("\n", trim: true) |> Enum.with_index(),
        {c, j} <- r |> to_charlist() |> Enum.with_index(),
        into: %{}, do: {{i, j}, c}
  end
  def part1(m) do
    Enum.count(m, fn {_, c} -> c in [?., ?S] end)|>IO.inspect()
    s = Enum.find_value(m, fn {p, c} -> c == ?S && p end)
    for _ <- 1..64, reduce: MapSet.new([s]) do
      acc -> for {i, j} <- acc,
                 p <- [{i + 1, j}, {i, j + 1}, {i - 1, j}, {i, j - 1}],
                 m[p] && m[p] != ?#,
                 into: MapSet.new(), do: p
    end
    |> Enum.count()
  end
  def mod({i, j}, n), do: {Integer.mod(i, n), Integer.mod(j, n)}
  def part2(m) do
    #XXX walk 3-block wide bands to find boundary, garbage collect, edge is 45-degree ramp and symmetric, inner blocks are alternating between odd and even steps
    {n, n} = m |> Map.keys() |> Enum.max()
    n = n + 1
    s = Enum.find_value(m, fn {p, c} -> c == ?S && p end)
    for step <- 1..5000, reduce: {MapSet.new([s]), MapSet.new()} do
      {last, prev} ->
        IO.inspect({step, Enum.count(last)})
        for {i, j} <- last, p <- [{i + 1, j}, {i, j + 1}, {i - 1, j}, {i, j - 1}],
            m[mod(p, n)] != ?# and p not in prev, into: MapSet.new() do p end
        #|> tap(&print(m, n, &1, step))
        |> then(&{&1, last})
    end
    |> elem(0)
    |> Enum.count()
  end
  def print(m, n, set, step) do
    x = {5, 5}
    y = Enum.filter(set, &mod(&1, n) == x) |> Enum.map(fn {i, j} -> {floor(i / n), floor(j / n)} end)
    if y != [] do
      IO.puts("step: #{step} length: #{Enum.count(set)} count: #{length y} #{inspect y}")
      m
    end
    #{{i1, i2}, {j1, j2}} = Enum.unzip(set) |> then(fn {is, js} -> {Enum.min_max([0, 10 | is]), Enum.min_max([0, 10 | js])} end)
    #for i <- i1..i2 do
    #  for j <- j1..j2 do
    #    p = {i, j}
    #    q = mod(p, n)
    #    case {p in set, q == x} do
    #      {true, true} -> ?@
    #      {true, _} -> ?O
    #      {_, true} -> ?X
    #      _ -> m[q]
    #    end
    #  end
    #end
    #|> Enum.join("\n")
    #|> IO.puts()
  end
end

input = """
...................................................................................................................................
........#..#..#..........#..........#.........#.......................#....#....##....#.......#.....#.#.....##..........#..#.......
................#.....#.#...#.##.......#...........#...#.#.......................#....#...#...#....#...............#.........#.....
.............#................##.#........#.#.......................................#.#............##................#.....#.......
.................#......................#.#....#.........................#.#...........#...........#.................#....##.#.....
.......#................#...#.....#.......#...##.................................#............#....#..#.......##...#...##........#.
.......#...........#....#..#......................#...............................#......#.......#..#....#.......................#.
.........#.....#..#....##...........##.....#..#.....................................#............#..........................#......
..............#..........#.......##..........#......#.................................#......................###.#.............#...
.......................#...............##...#..##............#......................#.......#......................##..............
..##......#...#..##..#..##...#...#..............#..................#............#.....#.........#.....#..##......#...#.............
..#.#.........#.......#.#...#.....#....#...#...#..........##..#....#.#..#...........#.........................#....................
.....#....#..........#....#.......#......#.......#..........#.#....#.................#....#....#.........................#.........
..#...........#.#.....###.......#............#.##......................#...............#.##...#...........................#........
............#.#....#.#.#.#.....#.....#....#..#...............#...........................#.....#......#....#..#................##..
..#........#....................###.........#...........#.#........##.................##...#..........#..........#.........#.......
........#........##..#........#.....#...#................##.....#.......................#......................#.............##....
...........#.....#...............#.......................##............................##...............#.....#....#.............#.
.............#........##..####..#......#...#................#..#................................#.........#........................
.##...#..............#....##...........#.......................#..........#............................#.......#.........#.#.......
........#.........................#...............#........#..................#...............#..........##.#.........#............
......#..#....#................#....#.......................#.............................#....##...........#......................
..#.....#.#.......#...#...........#.#................#.........##...............................#........#.#..................#....
...#..#......#..#................#..............................#...............#......................#...#.....#..#.....#........
...#....#.........##..............#.................#..#................##...........#.....................#.#.....#.........#...#.
..#..##.....#..........##..#...#.......................#.....#....#................#..#............#.#.............................
........#......#...#....#..........#.......#........#.#..#......#............#..#..............##................#..........##.....
.....#.........#..#..#........#............#.#........#.............#.....#...#.......#.......................................#..#.
......#......................................##............#............#...#....#...............#....#.....#..#.........#.......#.
....#.....#..............#....##............#......#.......#..##.......................................#........#..#...............
..........#....#.#.....##.#.................#..........#....#.............#....#........#..................#....#.....##....##.....
...........#...##....#.##...............##.....#..#..#...#..#..#...#............#....................#.........#.............#.....
.......#........##..........#...........................#...........................##..............................#....#.....#.#.
........###...#............................#...#...................##.#.#...........#..................#............#...#..........
..#.....#.#......#......#.#........##....#.............#....#...#....#......#........#..##.............#.#...#.........#.....#.....
...........##..............................#.##.......#.......#.........#.#.............................#...#......#..#...#...#....
........#....#......#.............#..#.#.##.#..#..#..#.......#....#......#.....#....#.....#......#.................................
..........#...........#.........##...#...............................##.............#......##....#...................#..#...#....#.
.............#...#.#.............#..#........#.................#.......#.............#...................................#.#.....#.
......#.#................................##.....###...........#........#....................#.....#.#....................#...##....
..##.........#.#.#.......................#............###....#.................#....#...........#..............#.#..#.#............
.......#.......................................#.....#......#...............#................#.................#...#.....#..#......
.............................#.....#.....#...........#.....#..#.....................##.............................................
....#......................................#.#.......................................#...............................#.............
............................................#....#..#..#.................##...#..#.........................................#...#...
.....#......................#................##.....................#......#....#...#........#........#......................#...#.
...##..........#......................#............##..........#....................................................#......#.#.....
............#................#...........##................................##....#.#...#.....#.....................................
.............#............#..................#.......#............#...##.#........#......#...#......#..................#.......#...
........#...............#...#......##...........#.....#..#......#......#........#.#...#.........#.........###.#.........##....#.#..
..........#..................#..##.......#.........##.......#......#.....#.....#.##.......#....#................................#..
.......#...........#...#......##.............#.......##....##.................#..#.............#....#........#..........#.#.....#..
........#...........#...#..............#....#.....#............#...#.....#...#............................#....#...................
.....####........#.....##........#.......#.........#..#.....#.....#..#.......#..#.......#........#.#...#.......#..........#...#..#.
......##.......#..#..#.#..................#.........#......#.....................#.......#.#..........#.........#..........##......
...................#......##...............#....#.......................#..#.......#..#..............#.............................
......................................#........#.........#..........#......#.#.....#...........#.................#...............#.
..................##...........##.#.#..#..##..............#........................#...............#......#...#....#...............
.............#....#..............................#.#..####....#....#..#..#.......................#.##......#..#.......#............
..................#.#.........#........#...#.....#........................#.............#..#................#...........#.......#..
............#...............#.......##.....##..................#...........#....#.....#........#.......................#...........
.........#....#.#...#.#...#........#.......#...#....#..............#.....#........#.#.#...........#...##....##.#..#................
................#.#...........#.........#..#...#.#.#..#......#.##............#....####..#..........##..#......#..#.................
......#...#......................#..#......#......#...............................................#...#..#....#.....#..............
........#.#.....#...........#...#........#...#..##..#....#.....##.................##.#......#....#.........#.....##.#...#..........
.................................................................S.................................................................
......................#....#......#.#..#......#....##...........#.....#...............#...#.......#........##......................
..............#............#...#..........#.........#......#.........#..............................#.....##.........#...#.........
..............#........#................#....#..............#.......#...................##..............#..#....#.#.....#..........
...........#........#.....#........................#......................###..............#......#.#....#.........................
.............#...#.....#.#..#..#....##....#...............#...#........................#.#..#......#..................##...........
.............#...#.................#.................#..#.............#.#....#......#.#..##.#......#...#..#........#.............#.
..............#.....#...................#.........#..#.........#....................#..............................#...............
.#.................#.#.#....#......##.#....................#...#......#........##..............#................#..................
..............#....#...........###...#.....#.......#.......................#.................#....#...#..............#.............
...............#...........................#.......#.....#..........#..............................................................
...............................................#...........##..#..........#..............#...#...........#......#.............##...
......#............#..##................#.............................................#..........#..........#.....#................
..................###........#..#.......#...#...........###.#.#...........................#................#...............#.#.....
...#.#..............#.....#...#....#............................#....#....#..........#..........#.##.#....#.................#....#.
.#...................#..........#......#...#.....#........#.....................#...........#..............................#.......
..#.#...#..#........#..#.....##..#......#.............#................#...#.........#......#...........#...................#......
..##...##.................#.....#............#..#.....#..#....#.....#....#.............#.............##......#........#......#..#..
....#...#..#..#.............#.....#...#...............#........#..#...#...#........#...............#.............................#.
...#...#.................#............#..#......#..................................#........#.......#.#............##.......##...#.
......#...................................#.#....#........#.......#..................#...................................#..#......
......#.##......#............#.#.......................#.....#....##..#................#...........#.................#.......##....
...#...#..#....#..............#................................#.......#.......#....#................#...........................#.
....#.#.........#......................#......##................#.......#....#....#.#......#..#...................#....#....#....#.
.......#........................#.....#................#..#.#..................................#....#..........##...#..#...........
.................#...........#................##.#......................#...#..#..#...#.....#.......#.............#..#..#.#........
......#..#...........#.................#....#.#............#...............#..#....#..#.......#......................#..#..#.#.....
...#.#.....#.......................#.......#...................##...............#....#.#..#.......#..............#....#.......#....
...............#....#............#................................##.........................................#.........#.....#..#..
..#...................##................#..........................#......#..####...............#.........#........#...#...........
....#..................#.#........#.....###..................#..........#.#.#...#.#...#........#..........#....##.#.............#..
..#.................................#.#....#.#.......#.##.................#........#..........................#....................
...#..#.....................#.......##.....................#.................#.........................#.........#..#.....#........
..#....#..............................#...#...#...............##..........#.................#........#..#.#.....#.#.......#........
..#............#....#........#...........#...........#.......................................................#................#..#.
.#...##...#.........#..........#...................#....#....#..#..............#.......................#..#......#.................
...#..#................#................#.........#.......#.........#.......#..............................#.....#.................
......................#..#....#..........#........#..##..............#..##...........#...........#............#.........#..........
.....#..................................................................................#.......#...#.#....................#.......
........#...#..#..............#.#.#...........#.#..#..........#....#.#...........................................#..#...##.........
..........#....#......##....#......................##..#.#...........#......#........................##.#.......#.#......#.........
....#................#...#.#...............................##..............#..............................#...#.##.........#...#...
..............#............#......##.......................................................................#.......#...............
....#...........#.#.#.............#...................#...........#.....................................#......#...................
...#........................#............................#..............#......................##....##.....#...#..#...#...........
....#...........#.....................................................#.....#.#...............#...............................#....
..........................#........#.#............#........#...#......#......#..#..............................#....#.....#........
.#........#............#...............................#..................#.#......................................##....#.........
.....#.#...#.##....#........#..........##.............#...#...................#...............#......#.#...........##....#.........
............#........#.................#.............##....#..............................#.....#..##..#......#............#.......
...............#...#.#...........##................................#.....................#..........#................#....#.#......
......##.......#..#..#.#.......#...#........#.............#........#...#....................................#....#......#..........
...........#.........#........#.#...........#............#.........................#.........#....#.....#......#.#.#...##..#.#...#.
.....#......#........#.......................#.............##....................#............................#..#..#...#.....#..#.
.#.#.#..........#............##.......#.....#.#...............#.....#..#..........#..#.#...#...#............#......#.#...#.........
.#..#......#.#..#...#....#.........#.....##.....##..........##......#................#....#.......#..#......#...........#......#...
.......#.....................#.#...........##......#...............................#.......#...................#...........##.#....
....#..................#............#...........#.....................................................#.................#...#......
....#..#..#................#.....#.....#.........#..........................#..#......#..........................................#.
...........#......#....#.............#...#...##........................................#........##.............##.....#..#.........
.......##......##.............##..................#.#........................#..#.....#............#.....##.#............#..#..#...
............#...#...............................#......#.#...................#...#.#..............#.........#..........#.#......#..
...........#.........#......#............#.....................................#....#.......#.....#.......................#.....#..
.................#.##.....................#.............#.#..............................................................#.........
.........#.#..#...........#....#.....#....#...............##.........................#....#.....#.......#..................###..#..
...................................................................................................................................
"""

_ = """
...........
.....###.#.
.###.##..#.
..#.#...#..
....#.#....
.##..S####.
.##..#...#.
.......##..
.##.#.####.
.##..##.##.
...........
"""
input
|> D21.parse()
|> D21.part1()
|> IO.inspect(label: :part1, charlists: :as_lists)

_ = """
...........
.....###.#.
.###.##..#.
..#.#...#..
....#.#....
.##..S####.
.##..#...#.
.......##..
.##.#.####.
.##..##.##.
...........
"""
#input
|> D21.parse()
|> D21.part2()
|> IO.inspect(label: :part2, charlists: :as_lists)

